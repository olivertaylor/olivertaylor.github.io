<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2021-02-02 Tue 21:52 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DRAFT: Extending Emacs Bookmarks to Work With EWW</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Oliver Taylor" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">DRAFT: Extending Emacs Bookmarks to Work With EWW</h1>
<p>
<a href="https://www.gnu.org/software/emacs/manual/html_node/emacs/Bookmarks.html">Emacs bookmarks</a> are pretty wonderful, you can bookmark almost anything: files,
directories, info and help buffers, <a href="https://magit.vc">Magit</a> buffers, <a href="https://github.com/skeeto/elfeed#bookmarks">elfeed</a> searches and
entries. And, naturally, you can extend Emacs to be able to bookmark almost
anything you want. This note demonstrates how to extend Emacs to use the
standard bookmark system with the <a href="https://www.gnu.org/software/emacs/manual/html_mono/eww.html">EWW browser</a>.
</p>

<hr />

<p>
Let's start by taking a closer look at what a bookmark looks like under the
hood. When you type <code>M-x bookmark-set</code> Emacs adds a 'record' to the
<code>bookmark-alist</code>. This list is then saved to a file (defined in the variable
<code>bookmark-default-file</code>) so you don't loose your bookmarks when you quit Emacs.
The individual bookmark records look like this:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">("(emacs) Bookmarks"
 (front-context-string . "13.8 Bookmarks\n=")
 (rear-context-string . " Up: Registers\n\n")
 (position . 251555)
 (filename . "/Users/oht/Applications/Emacs.app/Contents/Resources/info/emacs")
 (info-node . "Bookmarks")
 (handler . Info-bookmark-jump))
</pre>
</div>

<p>
Let's break that down piece-by-piece.
</p>

<ul class="org-ul">
<li><code>(emacs) Bookmarks</code> is the name of the bookmark, and what gets displayed in
the bookmark list.</li>
<li><code>front-context-string</code> and <code>rear-context-string</code> help keep your bookmarks
accurate when you edit a file after setting a bookmark. If you simply
recorded the filename and line number subsequent edits to the file would
quickly render your bookmarks inaccurate.</li>
<li><code>position</code> is the point's position in the buffer.</li>
<li><code>filename</code> is pretty self explanatory, as is <code>info-node</code> (which is specific to
bookmarking the info manuals).</li>
<li><code>handler</code> defines the function that <code>bookmark-jump</code> will use to go to that
bookmark.</li>
</ul>

<p>
Detailed information about how bookmark records can be found by describing the
variable <code>bookmark-alist</code>.
</p>

<p>
With a little imagination, one can envision a bookmark record for a webpage
that looks something like this:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">("Name of Webpage"
 (location . "https://example.com")
 (handler . eww-handler-function))
</pre>
</div>

<p>
Emacs refers to a function which creates these records as a "bookmark make
record function". In this case that function might look like this:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(defun custom-make-record-function ()
  `(,(name-bookmark-function)
    (location . ,(get-url-function))
    (handler . eww-handler-function)))
</pre>
</div>

<p>
Emacs uses a different function to create each kind of bookmark; for example
it has one function for bookmarking files and another for bookmarking
directories. Defining which function to use in which context is the job of the
variable <code>bookmark-make-record-function</code>. When you type <code>M-x bookmark-set</code> Emacs
will check that variable and call the associated function, thus creating your
custom bookmark record, and it will insert the record into the <code>bookmark-alist</code>.
</p>

<p>
Now that we understand how it works, we can enumerate all the pieces we'll
need.
</p>

<ol class="org-ol">
<li>We need to write a function which creates a properly formatted bookmark
record.</li>
<li>We need a way to open the URL from the bookmark list, a 'handler' function.</li>
<li>We need to set the variable <code>bookmark-make-record-function</code> locally when EWW
buffers are created.</li>
</ol>

<p>
First, the make-record function. You can grab the url from EWW with the
function <code>eww-current-url</code> but EWW provides no such function for getting the
page's title. You can grab the page title with a little lisp:
<code>(plist-get eww-data :title)</code>
</p>

<p>
However, EWW seems to only update the title data when creating a new EWW
buffer and not after you've followed one of the links in that buffer. I've
attempted to hack-together a solution, however my Emacs-fu is not strong
enough. If you have a solution for this, please let me know and I'll
update this note.
</p>

<p>
The complete make-record function looks like this:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(defun oht-eww-bookmark-make-record ()
  "Make a bookmark record for the current eww buffer"
  `(,(plist-get eww-data :title)
    (location . ,(eww-current-url))
    (handler . oht-eww-bookmark-handler)))
</pre>
</div>

<p>
Second, the handler function for jumping to the URL:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(defun oht-eww-bookmark-handler (record)
  "Jump to a bookmark's url with bookmarked location."
  (eww (bookmark-prop-get record 'location)))
</pre>
</div>

<p>
Third, we need to set the buffer-local variable <code>bookmark-make-record-function</code>
to the name of our custom make-record function. We do this by first defining a
function which sets the local variable, then adding a hook to <code>eww-mode</code> which
calls that function. Like this:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(defun oht-eww-set-bookmark-handler ()
  "Assigns `bookmark-make-record-function' to a custom function"
  (set (make-local-variable 'bookmark-make-record-function)
       #'oht-eww-bookmark-make-record))

(add-hook 'eww-mode-hook 'oht-eww-set-bookmark-handler)
</pre>
</div>

<hr />

<p>
Now, when visiting a page in EWW you can type <code>M-x bookmark-set</code> and a bookmark will
be created, and jumping to that bookmark will open the URL in EWW.
</p>

<p>
While this example is specific to the EWW browser, it should give you an idea
of how you can extend Emacs's bookmarking system in other ways.
</p>
</div>
<div id="postamble" class="status">
<p class="author">Author: Oliver Taylor</p>
<p class="date">Created: 2021-02-02 Tue 21:52</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
